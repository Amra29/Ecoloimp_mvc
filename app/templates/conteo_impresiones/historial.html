{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Historial de Conteo de Impresiones</h1>

    <!-- Resúmenes Totales -->
    <div class="row">
        <!-- Total de Impresiones -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total de Impresiones
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(total_impresiones) }}
                            </div>
                            {% if promedio_diario %}
                            <div class="mt-2 text-xs text-muted">
                                <i class="fas fa-calendar-day me-1"></i> {{ "{:,}".format(promedio_diario.impresiones|round|int) }} por día
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-print fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Total de Escaneos -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total de Escaneos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(total_escaneos) }}
                            </div>
                            {% if promedio_diario %}
                            <div class="mt-2 text-xs text-muted">
                                <i class="fas fa-calendar-day me-1"></i> {{ "{:,}".format(promedio_diario.escaneos|round|int) }} por día
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-copy fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Total de Copias -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total de Copias
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(total_copias) }}
                            </div>
                            {% if promedio_diario %}
                            <div class="mt-2 text-xs text-muted">
                                <i class="fas fa-calendar-day me-1"></i> {{ "{:,}".format(promedio_diario.copias|round|int) }} por día
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clone fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de búsqueda -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form id="filtroForm" method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="fecha_desde" class="form-label">Fecha desde</label>
                    <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" value="{{ request.args.get('fecha_desde', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="fecha_hasta" class="form-label">Fecha hasta</label>
                    <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" value="{{ request.args.get('fecha_hasta', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="cliente_id" class="form-label">Cliente</label>
                    <select class="form-select" id="cliente_id" name="cliente_id">
                        <option value="">Todos</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" {% if cliente.id == request.args.get('cliente_id', type=int) %}selected{% endif %}>{{ cliente.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i> Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla principal -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Fecha Conteo</th>
                            <th>Cliente</th>
                            <th>Equipo</th>
                            <th>Impresiones</th>
                            <th>Escaneos</th>
                            <th>Copias</th>
                            <th>Técnico</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for conteo in conteos %}
                        <tr>
                            <td>{{ conteo.fecha_conteo.strftime("%d/%m/%Y") }}</td>
                            <td>{{ conteo.equipo.cliente.nombre }}</td>
                            <td>{{ conteo.equipo.marca }} {{ conteo.equipo.modelo }} ({{ conteo.equipo.numero_serie }})</td>
                            <td class="text-end">{{ conteo.impresiones_desde_ultimo }}</td>
                            <td class="text-end">{{ conteo.escaneos_desde_ultimo }}</td>
                            <td class="text-end">{{ conteo.copias_desde_ultimo }}</td>
                            <td>{{ conteo.tecnico.nombre }}</td>
                            <td>
                                <!-- Acciones -->
                                <a href="{{ url_for('conteo_impresiones.ver', id=conteo.id) }}" class="btn btn-sm btn-info" title="Ver detalle"><i class="fas fa-eye"></i></a>
                                {% if current_user.tiene_permiso('editar_conteo') %}
                                <a href="{{ url_for('conteo_impresiones.editar', id=conteo.id) }}" class="btn btn-sm btn-warning" title="Editar"><i class="fas fa-edit"></i></a>
                                {% endif %}
                                {% if current_user.tiene_permiso('eliminar_conteo') %}
                                <a href="{{ url_for('conteo_impresiones.eliminar', id=conteo.id) }}" class="btn btn-sm btn-danger" title="Eliminar" data-confirm-delete><i class="fas fa-trash"></i></a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" class="text-end">Totales:</th>
                            <th class="text-end">{{ "{:,}".format(conteos|sum(attribute='impresiones_desde_ultimo')) }}</th>
                            <th class="text-end">{{ "{:,}".format(conteos|sum(attribute='escaneos_desde_ultimo')) }}</th>
                            <th class="text-end">{{ "{:,}".format(conteos|sum(attribute='copias_desde_ultimo')) }}</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Programar Mantenimiento (si corresponde) -->
    {% if current_user.tiene_permiso('programar_mantenimiento') %}
    <div class="modal fade" id="programarMantenimientoModal" tabindex="-1" aria-labelledby="programarMantenimientoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="programarMantenimientoModalLabel">
                        <i class="fas fa-tools me-2"></i>Programar Mantenimiento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <form id="formMantenimiento" method="post" action="{{ url_for('mantenimiento.programar') }}">
                    <div class="modal-body">
                        <!-- Campos de mantenimiento -->
                        <div class="mb-3">
                            <label for="fecha_mantenimiento" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha_mantenimiento" name="fecha_mantenimiento" required>
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Programar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/chart.js/Chart.min.js') }}"></script>
<script>
// Inicialización de tooltips y DataTable
$(function () {
    $('[data-bs-toggle="tooltip"]').tooltip();
    $('#dataTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 25,
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.1/i18n/es-ES.json"
        }
    });
});

// Establecer fecha mínima de mantenimiento como mañana
document.addEventListener('DOMContentLoaded', function() {
    const fechaMantenimiento = document.getElementById('fecha_mantenimiento');
    if (fechaMantenimiento) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        fechaMantenimiento.min = tomorrow.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}